{% extends 'vendedor/base.html.twig' %}

{% block title %}{{ page_title|default('Novo Evento') }} - Dashboard{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{{ page_title|default('Novo Evento') }}</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ path('app_vendedor_dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <span data-feather="arrow-left" class="align-text-bottom"></span>
                Cancelar
            </a>
        </div>
    </div>

    {{ form_start(eventoForm) }}

    <div class="card mb-4">
        <div class="card-header">
            Detalhes do Evento
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    {{ form_row(eventoForm.nome) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(eventoForm.local) }}
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    {{ form_row(eventoForm.dataHoraInicio) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(eventoForm.dataHoraFim) }}
                </div>
                <div class="col-md-4">
                    {{ form_row(eventoForm.capacidadeTotal) }}
                </div>
            </div>

            <div class="mt-3">
                {{ form_row(eventoForm.descricao) }}
            </div>

            <div class="mt-3">
                {{ form_row(eventoForm.urlBanner) }}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            {{ form_label(eventoForm.lotes) }}
            <button type="button" class="btn btn-sm btn-success add-lote-button"
                    data-collection-holder-id="lotes-collection-wrapper">
                <i class="bi bi-plus-circle me-1"></i> Adicionar Lote
            </button>
        </div>
        <div class="card-body">
            <div id="lotes-collection-wrapper"
                 class="list-group"
                 data-index="{{ eventoForm.lotes|length > 0 ? eventoForm.lotes|last.vars.name + 1 : 0 }}"
                 data-prototype="{{ form_widget(eventoForm.lotes.vars.prototype)|e('html_attr') }}">

                {% for loteForm in eventoForm.lotes %}
                    <div class="list-group-item lote-item">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-3">{{ form_row(loteForm.nome) }}</div>
                            <div class="col-md-2">{{ form_row(loteForm.preco) }}</div>
                            <div class="col-md-2">{{ form_row(loteForm.quantidadeTotal) }}</div>
                            <div class="col-md-2">{{ form_row(loteForm.dataInicioVendas) }}</div>
                            <div class="col-md-2">{{ form_row(loteForm.dataFimVendas) }}</div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-sm btn-danger remove-lote-button">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-4">
        <span data-feather="save" class="align-text-bottom"></span>
        Salvar Alterações
    </button>

    {{ form_end(eventoForm) }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const addFormToCollection = (e) => {
                const collectionHolder = document.querySelector('#' + e.currentTarget.dataset.collectionHolderId);
                const prototype = collectionHolder.dataset.prototype;
                const index = collectionHolder.dataset.index;

                let newForm = prototype;

                // Substitui o placeholder __lote_proto__ pelo índice atual
                newForm = newForm.replace(/__lote_proto__/g, index);

                collectionHolder.dataset.index = parseInt(index) + 1;

                // Cria o wrapper do item (list-group-item)
                const item = document.createElement('div');
                item.classList.add('list-group-item', 'lote-item');

                // Estrutura interna (row)
                const row = document.createElement('div');
                row.classList.add('row', 'g-2', 'align-items-center');

                // Divide o formulário nos campos
                const colNome = document.createElement('div');
                colNome.classList.add('col-md-3');

                const colPreco = document.createElement('div');
                colPreco.classList.add('col-md-2');

                const colQtd = document.createElement('div');
                colQtd.classList.add('col-md-2');

                const colInicio = document.createElement('div');
                colInicio.classList.add('col-md-2');

                const colFim = document.createElement('div');
                colFim.classList.add('col-md-2');

                const colBtn = document.createElement('div');
                colBtn.classList.add('col-md-1');

                // Regex para extrair os campos do protótipo
                const fields = newForm.match(/<div class="mb-3">(.+?)<\/div>/g);

                if (fields && fields.length >= 5) {
                    colNome.innerHTML = fields[0];
                    colPreco.innerHTML = fields[1];
                    colQtd.innerHTML = fields[2];
                    colInicio.innerHTML = fields[3];
                    colFim.innerHTML = fields[4];
                }

                // Adiciona o botão de remover
                const removeButton = document.createElement('button');
                removeButton.type = 'button';
                removeButton.classList.add('btn', 'btn-sm', 'btn-danger', 'remove-lote-button');
                removeButton.innerHTML = '<i class="bi bi-trash"></i>';
                colBtn.appendChild(removeButton);

                // Monta a estrutura
                row.appendChild(colNome);
                row.appendChild(colPreco);
                row.appendChild(colQtd);
                row.appendChild(colInicio);
                row.appendChild(colFim);
                row.appendChild(colBtn);
                item.appendChild(row);

                collectionHolder.appendChild(item);
            };

            const removeFormFromCollection = (e) => {
                if (e.target.classList.contains('remove-lote-button') || e.target.closest('.remove-lote-button')) {
                    e.target.closest('.lote-item').remove();
                }
            };

            // Event listener para Adicionar
            document.querySelectorAll('.add-lote-button').forEach(btn => {
                btn.addEventListener("click", addFormToCollection);
            });

            // Event listener para Remover (usando delegação de evento)
            document.getElementById('lotes-collection-wrapper').addEventListener('click', removeFormFromCollection);
        });
    </script>
{% endblock %}